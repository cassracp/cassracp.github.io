<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejamento de Implantação</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="../stylesheets/themes/dark-theme-modal.css">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        #printable-area { background-color: #fff; padding: 25px; border: 1px solid #ddd; }
        .header, .footer { text-align: center; margin-bottom: 20px; }
        .header img { max-width: 150px; }
        .footer { font-size: 0.8rem; color: #6c757d; margin-top: 20px; }
        .section-title { font-weight: bold; background-color: #e9ecef; padding: 8px; margin-top: 20px; }
        .module-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        .date-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center; }
        .date-grid label { margin-bottom: 0; }
        .summary-box { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; }
        @media print { body, #printable-area { margin: 0; padding: 0; border: none; } .non-printable { display: none; } }
    </style>
</head>
<body>
    <div id="printable-area">
        <div class="header">
            <img src="../site/icons/icon_base96.png" alt="Logo DeMaria">
            <h5>PLANEJAMENTO DE IMPLANTAÇÃO REMOTA</h5>
        </div>

        <div class="form-group row">
            <label class="col-sm-2 col-form-label">Cliente/Cartório:</label>
            <div class="col-sm-10"><input type="text" class="form-control" id="cliente-nome" placeholder="Nome do Cliente/Cartório"></div>
        </div>
        <div class="form-group row">
            <label class="col-sm-2 col-form-label">Oficial/Tabelião:</label>
            <div class="col-sm-10"><input type="text" class="form-control" id="cliente-oficial" placeholder="Nome do Oficial/Tabelião"></div>
        </div>
        <div class="form-group row">
            <label class="col-sm-2 col-form-label">Responsável:</label>
            <div class="col-sm-10"><input type="text" class="form-control" id="cliente-responsavel" placeholder="Nome do Responsável"></div>
        </div>

        <div class="section-title">MÓDULOS CONTRATADOS</div>
        <div id="modulos-container" class="module-grid mt-3"></div>

        <div class="section-title">DATAS AGENDADAS</div>
        <div id="atividades-container" class="date-grid mt-3"></div>
        
        <div class="section-title">RESUMO E OBSERVAÇÕES</div>
        <div class="summary-box mt-3">
            <p><strong>Total de agendamentos:</strong> <span id="total-agendamentos">0</span> dias úteis de implantação.</p>
            <p><strong>Período total:</strong> <span id="periodo-corridos">0</span> dias corridos.</p>
            <hr>
            <h6>OBSERVAÇÕES E CONSIDERAÇÕES</h6>
            <p>No agendamento de "Configurações Iniciais 1" será feita a instalação do Banco de Dados no Servidor do cartório e do sistema DOC-Windows nas Estações de Trabalho. Dependendo da quantidade de Estações de Trabalho a instalação poderá ser estendida para os agendamentos de "Configurações Iniciais 2 e 3".</p>
            <p>Todos as datas e horários de agendamento estão baseadas no fuso horário de Brasília.</p>
        </div>

        <div class="footer">
            <p>ADM Informática Ltda. | Av. Dr Sebastião Henrique da Cunha Pontes, 8000/8500 | SJC - SP | 0800 111-016 | www.demaria.com.br</p>
        </div>
    </div>

    <div class="footer-content non-printable">
        <button onclick="window.parent.tinymce?.activeEditor.windowManager.close()" class="btn btn-secondary">Fechar</button>
        <button onclick="generateRTF()" class="btn btn-success">Gerar RTF</button>
    </div>

    <script src="../scripts/app.js"></script>
    <script>
        let formDataJson = {};
        let assetsData = {};

        document.addEventListener('DOMContentLoaded', () => {
            applyModalTheme();
            loadInitialData();
        });
        async function loadInitialData() {
            try {
                const [planejamentoResponse, assetsResponse] = await Promise.all([
                    fetch('../data/planejamento-data.json'),
                    fetch('../data/assets.json')
                ]);
                formDataJson = await planejamentoResponse.json();
                assetsData = await assetsResponse.json();
                
                const modulosContainer = document.getElementById('modulos-container');
                formDataJson.modulos.forEach(mod => {
                    modulosContainer.innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" value="${mod.id}" id="chk-${mod.id}"><label class="form-check-label" for="chk-${mod.id}">${mod.label}</label></div>`;
                });
                const atividadesContainer = document.getElementById('atividades-container');
                formDataJson.atividades.forEach(atv => {
                    atividadesContainer.innerHTML += `<div class="form-group mb-2" id="row-${atv.id}" style="display: none;"><label for="date-${atv.id}" class="mb-0">${atv.label}</label></div><div class="form-group" id="date-input-row-${atv.id}" style="display: none;"><input type="datetime-local" class="form-control" id="date-${atv.id}" data-activity-id="${atv.id}"></div>`;
                });
                modulosContainer.addEventListener('change', updateVisibleActivities);
                atividadesContainer.addEventListener('change', calculateSummary);
                updateVisibleActivities();
            } catch (e) {
                console.error("Erro ao carregar dados iniciais:", e);
                alert('Falha ao carregar os dados de configuração.');
            }
        }

        function updateVisibleActivities() {
            const allActivities = document.querySelectorAll('#atividades-container [data-activity-id]');
            const checkedModules = Array.from(document.querySelectorAll('#modulos-container input:checked')).map(chk => chk.value);
            allActivities.forEach(input => {
                const activityId = input.dataset.activityId;
                const activityData = formDataJson.atividades.find(atv => atv.id === activityId);
                const moduloId = activityData.modulo_id;
                const row = document.getElementById(`row-${activityId}`);
                const dateInputRow = document.getElementById(`date-input-row-${activityId}`);
                if (!moduloId || checkedModules.includes(moduloId)) {
                    row.style.display = 'block';
                    dateInputRow.style.display = 'block';
                } else {
                    row.style.display = 'none';
                    dateInputRow.style.display = 'none';
                    input.value = '';
                }
            });
            calculateSummary();
        }

        function calculateSummary() {
            const dateInputs = Array.from(document.querySelectorAll('#atividades-container input[type="datetime-local"]')).filter(input => input.offsetParent !== null && input.value !== '');
            document.getElementById('total-agendamentos').textContent = dateInputs.length;
            if (dateInputs.length > 1) {
                const dates = dateInputs.map(input => new Date(input.value));
                const firstDate = new Date(Math.min(...dates));
                const lastDate = new Date(Math.max(...dates));
                const diffTime = Math.abs(lastDate - firstDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('periodo-corridos').textContent = diffDays;
            } else {
                document.getElementById('periodo-corridos').textContent = dateInputs.length;
            }
        }
        
        async function generateRTF() {
            // Função robusta para escapar caracteres para o formato RTF
            function rtfEscape(str) {
                const map = {
                    'á': '\\\'e1', 'Á': '\\\'c1', 'à': '\\\'e0', 'À': '\\\'c0', 'â': '\\\'e2', 'Â': '\\\'c2', 'ã': '\\\'e3', 'Ã': '\\\'c3',
                    'é': '\\\'e9', 'É': '\\\'c9', 'ê': '\\\'ea', 'Ê': '\\\'ca', 'í': '\\\'ed', 'Í': '\\\'cd', 'ó': '\\\'f3', 'Ó': '\\\'d3',
                    'ô': '\\\'f4', 'Ô': '\\\'d4', 'õ': '\\\'f5', 'Õ': '\\\'d5', 'ú': '\\\'fa', 'Ú': '\\\'da', 'ç': '\\\'e7', 'Ç': '\\\'c7',
                    '\\': '\\\\', '{': '\\{', '}': '\\}'
                };
                return str.replace(/[áÁàÀâÂãÃéÉêÊíÍóÓôÔõÕúÚçÇ\\{}]/g, char => map[char] || char);
            }

            const dados = {
                cliente: rtfEscape(document.getElementById('cliente-nome').value || 'Não informado'),
                oficial: rtfEscape(document.getElementById('cliente-oficial').value || 'Não informado'),
                responsavel: rtfEscape(document.getElementById('cliente-responsavel').value || 'Não informado'),
                diasTreinamento: document.getElementById('total-agendamentos').textContent,
                diasCorridos: document.getElementById('periodo-corridos').textContent
            };

            const modulosSelecionados = formDataJson.modulos.filter(mod => document.getElementById(`chk-${mod.id}`).checked);
            let modulosRTF = '';
            if (modulosSelecionados.length > 0) {
                const colWidth = 2250; 
                let tableRows = [];
                for (let i = 0; i < modulosSelecionados.length; i += 4) {
                    const chunk = modulosSelecionados.slice(i, i + 4);
                    let rowDef = `\\trowd \\trgaph108\\trleft-108\\clbrdrb\\brdrnone\\clbrdrl\\brdrnone\\clbrdrr\\brdrnone\\clbrdrt\\brdrnone\\cellx${colWidth}\\cellx${colWidth*2}\\cellx${colWidth*3}\\cellx${colWidth*4}`;
                    let cells = chunk.map(mod => `\\pard\\intbl {\\pntext\\f0\\'B7\\tab}${rtfEscape(mod.label)}\\cell`).join('');
                    for (let j = chunk.length; j < 4; j++) {
                        cells += `\\pard\\intbl \\cell`;
                    }
                    tableRows.push(rowDef + cells + '\\row');
                }
                modulosRTF = tableRows.join('');
            } else {
                modulosRTF = '\\pard\\sa200\\sl276\\slmult1 Nenhum m\\\'f3dulo selecionado.\\par';
            }

            const atividadesAgendadas = formDataJson.atividades
                .filter(atv => {
                    const input = document.getElementById(`date-${atv.id}`);
                    const row = document.getElementById(`row-${atv.id}`);
                    return row && row.style.display !== 'none' && input && input.value;
                })
                .map(atv => {
                    const input = document.getElementById(`date-${atv.id}`);
                    const date = new Date(input.value);
                    // Formato: dd/mm/aaaa hh:mm h
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const dataFormatada = `${day}/${month}/${year} ${hours}:${minutes} h`;
                    
                    // Sintaxe RTF para um item de lista com data em negrito
                    return `\\pard\\sa200\\sl276\\slmult1\\fi360{\\pntext\\f0\\'B7\\tab}${rtfEscape(atv.label)}: \\b ${rtfEscape(dataFormatada)}\\b0\\par`;
                })
                .join('');

            try {
                const response = await fetch('../references/modelo.rtf');
                if (!response.ok) throw new Error('Não foi possível carregar o arquivo modelo.rtf');
                
                const fileBlob = await response.blob();
                const rtfContent = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(fileBlob, 'windows-1252');
                });
                
                let finalRtf = rtfContent.replace('varCliente', dados.cliente);
                finalRtf = finalRtf.replace('varOficial', dados.oficial);
                finalRtf = finalRtf.replace('varResponsavel', dados.responsavel);
                finalRtf = finalRtf.replace('varModulos', modulosRTF);
                finalRtf = finalRtf.replace('varDatas', atividadesAgendadas);
                finalRtf = finalRtf.replace('countDias', dados.diasTreinamento);
                finalRtf = finalRtf.replace('countDiasCorridos', dados.diasCorridos);
                
                const finalBlob = new Blob([finalRtf], { type: 'application/rtf;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(finalBlob);
                link.download = `Planejamento - ${document.getElementById('cliente-nome').value || 'documento'}.rtf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("Erro ao gerar RTF:", error);
                alert("Ocorreu um erro ao gerar o arquivo RTF. Verifique o console para mais detalhes.");
            }
        }
    </script>
</body>
</html>

