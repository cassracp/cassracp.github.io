<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unificador de Scripts SQL</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="../stylesheets/themes/dark-theme-modal.css">
    <style>
        body { display: flex; flex-direction: column; height: 100vh; padding: 20px; background-color: #f8f9fa; }
        .main-content { flex-grow: 1; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; background-color: #fff; }
        .footer-content { flex-shrink: 0; padding-top: 15px; border-top: 1px solid #dee2e6; text-align: right; }
        .script-item { display: block; } /* Garante que cada checkbox fique em uma linha */
    </style>
</head>
<body>
    <h4>Unificador de Scripts SQL</h4>
    <p class="text-muted">Selecione os scripts de atualização para combinar em um único arquivo.</p>

    <div id="scripts-container" class="main-content">
        <p>Carregando scripts...</p>
    </div>

    <div class="footer-content">
        <button onclick="window.parent.tinymce.activeEditor.windowManager.close()" class="btn btn-secondary">Cancelar</button>
        <button id="btn-gerar" onclick="generateUnifiedScript()" class="btn btn-primary">Gerar Script</button>
    </div>

    <script src="../scripts/app.js"></script>
    <script src="../scripts/app.js"></script>
    <script>
        const VERCEL_API_URL = 'https://auxiliar-demaria.vercel.app/api';

         let lastChecked = null;

         function handleCheckboxClick(event) {
            const clickedCheckbox = event.target;

            // Verifica se o clique foi com a tecla Shift pressionada e se já existe um "último" checkbox
            if (event.shiftKey && lastChecked) {
                const container = document.getElementById('scripts-container');
                const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"]'));
                const startIndex = checkboxes.indexOf(lastChecked);
                const endIndex = checkboxes.indexOf(clickedCheckbox);

                // Determina o início e o fim do intervalo, não importa a ordem do clique
                const start = Math.min(startIndex, endIndex);
                const end = Math.max(startIndex, endIndex);

                // Marca (ou desmarca) todos os checkboxes dentro do intervalo
                for (let i = start; i <= end; i++) {
                    checkboxes[i].checked = lastChecked.checked;
                }
            }
            
            // Atualiza o "último" checkbox clicado para o atual
            lastChecked = clickedCheckbox;
        }

        /**
         * Função de ordenação personalizada para nomes de arquivos com versão (ex: r4.57 vs r4.6)
         * @param {object} a - Primeiro objeto de script ({name: '...'}).
         * @param {object} b - Segundo objeto de script ({name: '...'}).
         * @returns {number} - Resultado da comparação para a função sort().
         */
        function customVersionSort(a, b) {
            // Extrai a parte da versão dos nomes dos arquivos (ex: "4.57" ou "4.6")
            const versionA = (a.name.match(/r(\d+(\.\d+)*)/) || [])[1];
            const versionB = (b.name.match(/r(\d+(\.\d+)*)/) || [])[1];

            // Se não encontrar um padrão de versão, mantém a ordem original
            if (!versionA || !versionB) {
                return a.name.localeCompare(b.name);
            }

            // Divide a versão em partes numéricas (ex: "4.57" -> [4, 57])
            const partsA = versionA.split('.').map(Number);
            const partsB = versionB.split('.').map(Number);

            const maxLength = Math.max(partsA.length, partsB.length);
            for (let i = 0; i < maxLength; i++) {
                const partA = partsA[i] || 0;
                const partB = partsB[i] || 0;

                if (partA < partB) return -1;
                if (partA > partB) return 1;
            }
            return 0;
        }

        async function loadScripts() {
            const container = document.getElementById('scripts-container');

            container.addEventListener('click', (event) => {
                if (event.target.type === 'checkbox') {
                    handleCheckboxClick(event);
                }
            });

            try {
                const response = await fetch(`${VERCEL_API_URL}/list-scripts`);
                if (!response.ok) throw new Error('Falha ao buscar a lista de scripts.');
                
                const scripts = await response.json();

                // ORDENA A LISTA DE SCRIPTS USANDO A NOSSA NOVA FUNÇÃO
                scripts.sort(customVersionSort);

                if (scripts.length === 0) {
                    container.innerHTML = '<p>Nenhum script UPDATE_*.sql encontrado.</p>';
                    return;
                }

                container.innerHTML = '';
                scripts.forEach(script => {
                    const checkboxHTML = `
                        <div class="form-check script-item">
                            <input class="form-check-input" type="checkbox" value="${script.path}" id="chk-${script.name}">
                            <label class="form-check-label" for="chk-${script.name}">${script.name}</label>
                        </div>`;
                    container.innerHTML += checkboxHTML;
                });
            } catch (error) {
                console.error(error);
                container.innerHTML = '<p class="text-danger">Erro ao carregar scripts.</p>';
            }
        }

        async function generateUnifiedScript() {
            const btn = document.getElementById('btn-gerar');
            const checkedBoxes = document.querySelectorAll('#scripts-container input[type="checkbox"]:checked');

            if (checkedBoxes.length === 0) {
                Swal.fire('Atenção', 'Selecione pelo menos um script.', 'warning');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Gerando...';

            try {
                const filesToFetch = Array.from(checkedBoxes).map(chk => ({
                    path: chk.value,
                    name: chk.labels[0].textContent.trim()
                }));

                const scriptContents = await Promise.all(
                    filesToFetch.map(file =>
                        fetch(`${VERCEL_API_URL}/get-script-content?path=${encodeURIComponent(file.path)}`)
                            .then(res => {
                                if (!res.ok) throw new Error(`Falha ao baixar ${file.name}`);
                                return res.text();
                            })
                    )
                );

                // CORREÇÃO: Usa \r\n para quebras de linha do Windows
                let unifiedSqlContent = [];
                unifiedSqlContent.push('\\set ON_ERROR_STOP on\r\n\r\n');
                unifiedSqlContent.push('BEGIN;\r\n\r\n');

               scriptContents.forEach((content, index) => {
                    const fileName = filesToFetch[index].name;
                    unifiedSqlContent.push(`/*=====${fileName}=====*/`);
                    // Adiciona o conteúdo do arquivo e garante que termine com um ponto e vírgula
                    // e uma quebra de linha para separar do próximo script.
                    unifiedSqlContent.push(content.trim() + ';\r\n'); 
                });

                unifiedSqlContent.push('\r\n\r\nCOMMIT;');
                const finalSqlString = unifiedSqlContent.join('\r\n');

                // CORREÇÃO: Usa template literal que preserva as quebras de linha
                // e garante \r\n para o arquivo .bat 
                const batchContent = `@echo off
setlocal

REM Define a página de código para UTF-8
chcp 65001 > nul

REM Verifica se a variável de ambiente %SERVIDORDOC% está definida
if not defined SERVIDORDOC (
    echo Variável de ambiente %SERVIDORDOC% não está definida.
    echo Certifique-se de que o PostgreSQL esteja instalado e configurado corretamente.
    pause
    exit /b
)

REM Exibe mensagem informando o início do script
echo Iniciando o script de execução do script.sql...

REM Caminho para o psql.exe
set "psql=%SERVIDORDOC%\\bin\\psql.exe"

REM Verifica se o arquivo ScriptsUnificados.sql existe no mesmo diretório do arquivo batch
if not exist ScriptsUnificados.sql (
    echo O arquivo ScriptsUnificados.sql não foi encontrado no diretório do arquivo batch.
    pause
    exit /b
)

REM Executa o script SQL com o psql.exe
"%psql%" -U suporte -d docwin -f "ScriptsUnificados.sql"

REM Verifica o código de saída do comando psql.exe
if %errorlevel% neq 0 (
    echo Ocorreu um erro ao executar o script SQL.
) else (
    echo Script SQL executado com sucesso.
)

pause
exit /b
`.replace(/\n/g, '\r\n');


                if (window.parent.salvarTexto) {
                    window.parent.salvarTexto(finalSqlString, 'ScriptsUnificados.sql');
                    window.parent.salvarTexto(batchContent, 'RodarScripts.bat');
                    Swal.fire('Sucesso!', 'Os arquivos foram gerados e baixados.', 'success');
                } else {
                    throw new Error('Função salvarTexto não encontrada.');
                }

            } catch (error) {
                console.error(error);
                Swal.fire('Erro', 'Não foi possível gerar os arquivos.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Gerar Script';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            applyModalTheme();
            loadScripts();
        });
    </script>
</body>
</html>